Jmap=function(e){var t={},n,r={},i={},s={},o=[],u={eventsBind:function(e,t){for(var n=0,r=e.length;n<r;n++){var i=e[n].fn;Jock.event.add(e[n].obj,e[n].type,function(){i.call(t)})}},overlaysType:{overlay:"overlays",marker:"markers",ployline:"ployline"},init:function(e){window.mapData={},window.mapData.base={},window.mapData.entity={},window.mapData.sign={},window.map={},Jock.extend(i,Jock.map.options||{}),Jock.extend(i,e||{}),i.latlng=this.getLatLng(i),i.d&&typeof console!="undefined"&&console.log(i),Jock.extend(r,Jock.map.icOpts||{});if(!i.elm||typeof BMap!="object")return;i.elm=document.getElementById(i.elm),i.elm.style.background="none",this.setWH(),this.createMap()},setWH:function(e){var t=i.elm.style;if(e||!t.width)t.width="auto";if(e||!t.height)t.height=Jock.getHeight()-i.top+"px"},getMapWH:function(){return t.getSize()},createMap:function(){t=new BMap.Map(i.elm,{mapType:!i.u3d||i.city==""?BMAP_NORMAL_MAP:BMAP_PERSPECTIVE_MAP,minZoom:i.minz?i.minz:3,maxZoom:i.maxz?i.maxz:18}),!!i.u3d&&i.city!=""&&t.setCurrentCity(i.city),t.centerAndZoom(new BMap.Point(i.lng,i.lat),i.zoom);if(!!i.mark)var e=this.addMarker(i,"center");!i.ezoom||t.enableScrollWheelZoom(),t.enableKeyboard(),t.enableContinuousZoom(),t.enableInertialDragging();var n=new BMap.NavigationControl({anchor:BMAP_ANCHOR_TOP_LEFT,type:i.ctype?BMAP_NAVIGATION_CONTROL_LARGE:BMAP_NAVIGATION_CONTROL_ZOOM});t.addControl(n);if(!!i.scale){var r=new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT});t.addControl(r)}},setOverlaysVisible:function(e,t,n){var r=s[e];for(var i in r)this.setOverlayVisible(e,i,t)},setOverlayVisible:function(e,t,n){s[e]&&s[e][t]&&s[e][t].setVisible(n||!1)},getOverlay:function(e,t){return s[e]=s[e]?s[e]:{},s[e][t]},getOverlays:function(e){return s[e]?s[e]:undefined},clearOverlays:function(){t.clearOverlays(),s={}},removeOverlays:function(e){var t=s[e];for(var n in t)this.removeOverlay(e,n)},removeOverlay:function(e,n,r){if(e){if(Object.prototype.toString.call(e)=="[object Object]")return t.removeOverlay(e),r&&r.call(this),!0;s[e]&&s[e][n]&&(t.removeOverlay(s[e][n]),delete s[e][n],r&&r.call(this))}},pushOverlayList:function(e,t,n){s[e]=s[e]?s[e]:{},s[e][t]=n},getLatLng:function(e){var e=e||i;return new BMap.Point(e.lng,e.lat)},getMap:function(){return t||{}},reset:function(){t.reset()},getBounds:function(){return t.getBounds()},getBoundsWE:function(e){var n=this.getBounds(),r=n.getSouthWest(),i=n.getNorthEast();if(e&&typeof e=="number"){var s=t.pointToOverlayPixel(r),o=t.pointToOverlayPixel(i);s.x+=-e,s.y+=e,o.x+=e-30,o.y+=-(e-20),r=t.overlayPixelToPoint(new BMap.Pixel(s.x,s.y)),i=t.overlayPixelToPoint(new BMap.Pixel(o.x,o.y))}return{swlat:r.lat,nelat:i.lat,swlng:r.lng,nelng:i.lng}},inBounds:function(e){var t=this.getBounds();return typeof t=="object"?t.containsPoint(e):!0},pointToPixel:function(e){return t.pointToPixel(e)},addMarker:function(e,n,i){e.latlng=e.latlng?e.latlng:this.getLatLng(e);var s=i||this.buildOverlayKey(e.latlng),o=n||this.overlaysType.overlay;if(this.getOverlay(o,s))return;var u=new BMap.Marker(e.latlng,{icon:this.getMarkerImage(Jock.extend(r,e,!0))});e.title&&u.setTitle(e.title);if(e.showInfo){var a=this;Jock.event.add(u,"click",function(){a.openMarkerWindow(e)})}return t.addOverlay(u),this.pushOverlayList(o,s,u),u},getMarkerImage:function(e){return new BMap.Icon(e.icon,new BMap.Size(e.size.w,e.size.h),{anchor:new BMap.Size(e.offset.x,e.offset.y),imageOffset:new BMap.Size(e.imgOffset.x,e.imgOffset.y)})},openWindow:function(e){var n={};typeof e.offset!="undefined"&&(n.pixelOffset=new BMap.Size(e.offset.x,e.offset.y));var r=new BMap.InfoWindow(e.popInfo,n);t.openInfoWindow(r,e.latlng)},openMarkerWindow:function(e){this.openWindow(e)},openOverlayWindow:function(e,t){this.openWindow(e)},clone:function(e){if(null==e||"object"!=typeof e)return e;var t=e.constructor();for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},addOverlay:function(e,n,r){function l(e){this.p=e}var i=u.clone(e);i.latlng=i.latlng?i.latlng:u.getLatLng(i);var s=r||u.buildOverlayKey(i.latlng),o=n||u.overlaysType.overlay,a=u.getOverlay(o,s),f;if(a)return a;l.prototype=new BMap.Overlay,l.prototype.initialize=function(e){this._map=e,this._locked=!1,this._CName=this.p.className?this.p.className:"",this._CHover=this.p.classHover?this.p.classHover:"",this._barOffsetX=this.p.barOffset&&this.p.barOffset.x?this.p.barOffset.x:0,this._barOffsetY=this.p.barOffset&&this.p.barOffset.y?this.p.barOffset.y:0,f=this;var t=document.createElement("DIV");return t.style.position="absolute",t.style.cursor="pointer",t.style.zIndex=0,this._CName&&(t.className=f._CName),t.innerHTML=this.p.barInfo,t.title=this.p.title?this.p.title:"",this.p.showInfo&&Jock.event.add(t,"click",function(){u.openOverlayWindow(f.p,f)}),Jock.event.add(t,"mouseover",function(){f.setOver()}),Jock.event.add(t,"mouseout",function(){f.setOut()}),e.getPanes().labelPane.appendChild(t),this._div=t,t},l.prototype.setOver=function(){this._locked||(this._div.style.zIndex=1,this._CName&&this._CHover&&(this._div.className=this._CName+" "+this._CHover))},l.prototype.setOut=function(){this._locked||(this._div.style.zIndex=0,this._CName&&(this._div.className=this._CName))},l.prototype.setLock=function(e){e?this._locked=!0:this._locked=!1},l.prototype.draw=function(){var e=this._map,t=e.pointToOverlayPixel(this.p.latlng);this._div.style.left=t.x+this._barOffsetX+"px",this._div.style.top=t.y+this._barOffsetY+"px"},l.prototype.setVisible=function(e){this._div&&(this._div.style.visibility=e?"visible":"hidden")};var c=new l(i);return t.addOverlay(c),u.pushOverlayList(o,s,c),c},addPloyline:function(e,n,r,i){var s=i||this.buildOverlayKey(n.latlng),o=r||this.overlaysType.ployline;if(this.getOverlay(this.overlaysType.ployline,s))return;var u=Jock.extend({strokeColor:"#0030ff",strokeOpacity:.6,strokeWeight:6,enableMassClear:!0},n||{}),a=new BMap.Polyline(e,u);t.addOverlay(a),this.pushOverlayList(o,s,a)},buildOverlayKey:function(e){return e.lat+"_"+e.lng},getGeocoder:function(e,t,n){var r=new BMap.Geocoder;r.getPoint(e,t,n)},sw3d:function(){var t={};this.extend(t,opts||{}),this.extend(t,e||{}),this.extend(t,{u3d:1,zoom:17}||{}),this.init(t)},sw2d:function(){var t={};this.extend(t,opts||{}),this.extend(t,e||{}),this.extend(t,{u3d:0}||{}),this.init(t)},localSearch:function(e,n,r,i){var s=new BMap.LocalSearch(t);s.setPageCapacity(10),s.enableAutoViewport(),s.setSearchCompleteCallback(function(e){var t=[];if(s.getStatus()==BMAP_STATUS_SUCCESS){var o=e.getCurrentNumPois();while(o--){var u=e.getPoi(o),a={};a.title=u.title,a.point=u.point,a.address=u.address,t.push(a)}}n&&r&&(r.call(n,t,i),s=null)}),s.search(e)},localSearchNearby:function(e,n,r,i){if(!e)return;var s=new BMap.LocalSearch(t);i=i||1e3,s.setPageCapacity(r||50),s.enableAutoViewport(),s.setSearchCompleteCallback(function(e){var t=[];if(s.getStatus()==BMAP_STATUS_SUCCESS){var r=e.getCurrentNumPois();for(var i=0;i<r;i++)t.push(e.getPoi(i))}n&&n.call(null,t),s=null}),s.searchNearby(e,t.getCenter(),i)},setCenter:function(e,n,r){t.centerAndZoom(new BMap.Point(e,n),r),t.setCenter(new BMap.Point(e,n))},geolocation:function(e,t){var n=new BMap.Geolocation;n.getCurrentPosition(function(n){e&&t&&n&&t.call(e,n.point)})}};return u.init(e),Jock.extend(u,function(){function r(e,t){Jock.extend(e,e||{}),Jock.extend(e,{routeType:t})}function i(e){return document.createElement(e)}function s(e){var n=new BMap.LocalSearch(t,{onSearchComplete:function(t){function f(t,n){return function(){e.startTitle=n,e.start=t,e.isReSearch=!0,l(e)}}e.container.innerHTML="";var n=[],r=t.getCurrentNumPois(),s;if(r<=0)return e.container.innerHTML=c(e),!1;var o=i("div"),u=i("b"),a;o.style.cssText="clear:both; height:225px; overflow-x:hidden; overflow-y:auto; padding:8px 0 0 8px; line-height:26px;",u.style.cssText="font-size:13px; color:#666;",u.innerHTML="请确认起点",o.appendChild(u);for(var h=0;h<r;h++)s=t.getPoi(h),a=i("li"),a.style.cssText="padding:0 0 0 14px; margin-bottom:10px; float:left; background:url("+e.background+") 0 -305px no-repeat; width:195px; line-height:26px;",s.address=s.address?s.address:"",a.innerHTML='<span style="display:block;line-height:17px; cursor: pointer;"><a href="javascript:void(0)">'+s.title+"</a> "+s.address+"</span>",a.onclick=f(s.point,s.title),o.appendChild(a);e.container.appendChild(o)}});n.search(e.start)}function o(e){var t=e.getNumLines(),n=[];for(var r=0;r<t;r++){var i=e.getLine(r).title.replace(/\(.*\)/,"");n.push(i.match(/^\d+$/)?i+"路":i)}return n}function a(e,t,n,r){var i=t.getPlan(n),s=i.getRoute(0),u="",a=e.startTitle||t.getStart().title,l=e.endTitle||t.getEnd().title,c=[];len=0;var h=['<div id="sec_result" style="clear:both; overflow-x:hidden; overflow-y:auto; padding:8px 0 5px 6px; height:220px; font-size:12px;">'];h.push('<span style="margin:0 0 0 2px; display:block; color:#999; line-height:18px; font-size:12px;">');if(e.routeType=="driving")h.push('<b style="color:#666; font-size:13px;">全程</b>');else{u=o(i);for(var p=0;p<u.length;p++)c.push('<b style="color:#666; font-size:13px;">'+u[p]+"</b>");h.push(c.join('<b style="font-size:13px;">→</b>'))}h.push("    <br/>约"+i.getDuration()+" / "+i.getDistance()),h.push("</span>"),h.push('<span style="display:block; padding:2px 0 0 25px; height:24px; background:url('+e.background+') 0 -49px no-repeat; margin:10px 0 0; white-space:nowap; overflow:hidden;">'),h.push('    <span style="display:block; float:left; background:url('+e.background+') right 0 no-repeat; margin-left:2px; height:18px;">'),h.push('        <strong style="display:block; margin:0 8px 0 0; padding:0 0 0 8px; line-height:19px; background:url('+e.background+') 0 0 no-repeat; color:#fff;">'+a+"</strong>"),h.push("    </span>"),h.push("</span>"),h.push('<ul style="width:207px; border-top:1px solid #ddd;">');if(e.routeType=="driving"){len=s.getNumSteps();for(var p=0;p<len;p++)h.push(f(e,3,s.getStep(p).getDescription().replace(/<b>/gi,'<b style="color:#f60; font-weight: normal">'),p+1))}else{len=i.getNumRoutes();for(var d=0;d<len;d++){var s=i.getRoute(d),v=i.getLine(d);s.getDistance(!1)>0&&(d==len-1?h.push(f(e,2,'步行至<span style="color:#f60;">'+l+"</span>")):h.push(f(e,2,'步行至<span style="color:#f60;">'+v.getGetOnStop().title+"站</span>"))),d<len-1&&h.push(f(e,v.type,'乘坐<span style="color:#f60;">'+u[d]+"("+v.title.match(/-(.*[^)])[^\s]/)[1]+'方向)</span>在<span style="color:#f60;">'+v.getGetOffStop().title+"站</span>下车",e.background))}}return h.push("</ul>"),h.push('<span style="display:block; padding:2px 0 0 25px; height:24px; background:url('+e.background+') 0 -80px no-repeat; margin:5px 0 0; clear:both;">'),h.push('    <span style="display:block; float:left; background:url('+e.background+') right 0 no-repeat; margin-left:2px; height:18px;">'),h.push('        <strong style="display:block; margin:0 8px 0 0; padding:0 0 0 8px; line-height:19px; background:url('+e.background+') 0 0 no-repeat; color:#fff;">'+l+"</strong>"),h.push("    </span>"),h.push("</span>"),h.push("</div>"),h.join("")}function f(e,t,n,r){var i="",s=0;return t==0?s="-6px":t==1?s="-68px":t==2&&(s="-38px"),i='<li style="padding:5px 0; _padding:4px 0 0; width:207px; line-height:20px; border-bottom:1px solid #ddd;">',t==3?i+='  <i style="float:left;width:25px;height:18px;text-align:center;font-style: normal">'+r+".</i>":i+='  <i style="float:left; width:25px; height:18px; background:url('+e.background+") "+s+' -23px no-repeat;"></i>',i+='  <span style="float:left; width:180px;">'+n+"</span>",i+='  <div style="clear:both; margin:0; padding:0; height:0; line-height:0;"></div>',i+="</li>",i}function l(e){var t=null;return e.routeType=="transit"?(t=new BMap.TransitRoute(e.city),t.setPageCapacity(1)):t=new BMap.DrivingRoute(e.city),t.setSearchCompleteCallback(function(n){var r=t.getStatus(),i=0;if(r==BMAP_STATUS_SUCCESS)e.container.innerHTML=a(e,n,i),d(e,n,i);else if(r==BMAP_STATUS_UNKNOWN_ROUTE){if(e.isReSearch)return e.container.innerHTML=c(e),!1;s(e)}}),t.enableAutoViewport(),t.search(e.start,e.end),t}function c(e){return'<div style="clear:both; height:244px; overflow-x:hidden; overflow-y:auto; padding:8px 0 0 8px; line-height:26px;"><b style="font-size:13px; color:#666;">在 '+e.city+" 未找到相关地点，您可更换关键词再尝试。</b></div>"}function h(e){return r(e,"transit"),l(e)}function p(e){return r(e,"driving"),l(e)}function d(e,n,r){function a(e){for(var t=0;t<e.length;t++)i.push(e[t])}function f(e,t,n){Jock.extend(o,Jock.extend({latlng:e,title:t},n||{})),u.addMarker(o,"route")}u.removeOverlays("route");var i=[],s=n.getPlan(r),o={icon:e.background,showInfo:!1,size:{w:21,h:21},offset:{x:0,y:0},imgOffset:{x:0,y:0}};if(e.routeType=="transit")for(h=0;h<s.getNumLines();h++){var l=s.getLine(h);a(l.getPath()),l.type==BMAP_LINE_TYPE_BUS?(f(l.getGetOnStop().point,l.getGetOnStop().title,{size:{w:21,h:21},offset:{x:11,y:21},imgOffset:{x:0,y:-196}}),f(l.getGetOffStop().point,l.getGetOffStop().title,{size:{w:21,h:21},offset:{x:11,y:21},imgOffset:{x:0,y:-196}})):l.type==BMAP_LINE_TYPE_SUBWAY&&(f(l.getGetOnStop().point,l.getGetOnStop().title,{size:{w:21,h:21},offset:{x:11,y:21},imgOffset:{x:0,y:-227}}),f(l.getGetOffStop().point,l.getGetOffStop().title,{size:{w:21,h:21},offset:{x:11,y:21},imgOffset:{x:0,y:-227}})),u.addPloyline(l.getPath(),"","route","line"+h)}var c={strokeOpacity:.75,strokeWeight:4,enableMassClear:!0};e.routeType=="transit"?(c.strokeStyle="dashed",c.strokeColor="#30a208"):(c.strokeStyle="solid",c.strokeColor="#f0f");for(var h=0;h<s.getNumRoutes();h++){var p=s.getRoute(h);a(p.getPath()),p.getDistance(!1)>0&&u.addPloyline(p.getPath(),c,"route","route"+h)}f(n.getEnd().point,n.getEnd().title,{size:{w:40,h:32},offset:{x:20,y:16},imgOffset:{x:0,y:-154}}),f(n.getStart().point,e.startTitle||n.getStart().title,{size:{w:40,h:32},offset:{x:15,y:16},imgOffset:{x:0,y:-111}}),t.setViewport(i)}var e={container:"",city:"",background:"",start:"",end:"",startTitle:"",endTitle:"",routeType:"transit",isReSearch:!1},n=0;return{TransitRoute:h,DrivingRoute:p}}()),u};